# Project Lanlan 使用指南 - 新功能

## 新功能概述

本版本为Project Lanlan添加了两个重要功能：

### 1. 文本输入功能 💬
在聊天窗口中添加了文本输入框，允许用户通过文字与AI互动，而不仅限于语音输入。

### 2. Windows持久化Web运行器 🔄
改进了Windows启动脚本，确保后台服务持续运行，即使浏览器关闭也不会影响服务。

---

## 功能使用指南

### 文本输入功能使用

#### 第一步：启动应用
运行任一启动脚本：
- `启动网页版.bat` - 标准启动脚本
- `启动网页版_持久化.bat` - 推荐使用（提供更好的持久化支持）

#### 第二步：找到文本输入框
应用启动后，在左下角的聊天窗口底部可以看到：
- 文本输入框：显示"输入你的消息..."提示文字
- 发送按钮：蓝色的"发送"按钮

#### 第三步：输入消息
有两种方式发送消息：

**方式1：使用发送按钮**
1. 点击文本输入框
2. 输入你的消息
3. 点击"发送"按钮
4. 等待AI的响应

**方式2：使用键盘快捷键**
1. 点击文本输入框
2. 输入你的消息
3. 按 **Enter** 键
4. 等待AI的响应

#### 第四步：查看响应
- AI的响应会显示在聊天窗口中
- 消息带有时间戳
- 支持与语音输入无缝集成

### 文本输入的优势

✅ **随时随地输入** - 不需要麦克风或语音权限  
✅ **准确无误** - 避免语音识别错误  
✅ **隐私保护** - 不需要录音  
✅ **快速交互** - 即时发送消息  
✅ **与语音混合** - 可在语音和文本之间切换  

---

## Windows持久化运行器

### 推荐启动方式

1. 在项目文件夹中找到 `启动网页版_持久化.bat`（或使用窗口常驻版 `启动网页版.bat`）。
2. 双击运行脚本。命令行会依次启动 Memory Server 与 Main Server，并在任务栏生成同名的最小化窗口，它们会持续输出实时日志。
3. 等待脚本显示“服务已启动！”后，**手动**打开浏览器访问 `http://127.0.0.1:8000` 并完成 API Key 配置。

> 如果脚本提示 `错误：找不到Python环境`，请确认 `env\python.exe` 是否存在。

### 优势说明

| 功能 | 说明 |
|-----|-----|
| **后台运行** | 服务器后台运行，不阻塞窗口 |
| **持久化** | 浏览器关闭后服务仍在运行 |
| **独立性** | 可以重新打开浏览器访问 |
| **控制性** | 关闭窗口即关闭所有服务 |

### 快速启动

**Windows用户:**
1. 双击 `启动网页版_持久化.bat`
2. 观察“Memory Server”“Main Server”窗口是否报错
3. 看到“服务已启动！”提示后，手动打开浏览器访问 `http://127.0.0.1:8000`
4. 确认页面状态显示“连接已建立”

**浏览器重新连接:**
1. 关闭浏览器后等待 1 秒
2. 再次打开浏览器并访问 `http://127.0.0.1:8000`
3. 页面即刻恢复（后台服务从未停止）

### 日志位置与关闭语义
- “Memory Server”“Main Server”两个最小化窗口就是实时日志，遇到异常直接最大化查看。
- 项目根目录会生成 `lanlan_server_YYYYMMDD.log`，可用于排查“没有回复”等问题。
- 关闭浏览器只会发送 `/api/beacon/page_closed` 通知，服务继续运行；只有关闭启动脚本窗口或按 `Ctrl+C` 才会终止所有进程。

---

## 完整操作流程

### 第一次使用

```
1. 双击 启动网页版_持久化.bat
2. 等待命令行提示“服务已启动！”
3. 手动打开浏览器访问 http://127.0.0.1:8000
4. 在聊天窗口中输入首条文本消息（会自动启动文本会话）
5. 观察AI回复与Live2D动作
6. 关闭浏览器标签页验证服务仍在后台运行
7. 返回脚本窗口按 Ctrl+C 结束（需要继续使用则保持窗口打开）
```

### 日常使用流程

```
启动脚本
  ↓
手动打开浏览器 http://127.0.0.1:8000
  ↓
输入文字或开启语音
  ↓
观察AI回复
  ↓
按需关闭浏览器（服务继续运行）
  ↓
重新打开浏览器继续会话
  ↓
关闭启动脚本窗口/按 Ctrl+C 终止服务
```

## 文本输入端到端测试清单

1. 双击运行 `启动网页版_持久化.bat`，确认命令行没有报错。
2. 检查任务栏中的“Memory Server”“Main Server”窗口是否持续滚动日志。
3. 在浏览器访问 `http://127.0.0.1:8000`，确认顶部状态显示“连接已建立”。
4. 在文本框输入首条消息并发送，观察Live2D出现且状态变为“正在对话...”。
5. 记录AI回复（文本与语音），确认消息写入聊天历史。
6. 打开项目根目录的 `lanlan_server_YYYYMMDD.log`，确认包含当次对话和 `start_session input_type='text'` 相关日志。
7. 关闭浏览器标签页，再次访问 `http://127.0.0.1:8000` 验证服务仍在运行。
8. 使用“重置会话”按钮或按 `Ctrl+C` 关闭脚本窗口，确认两个服务器窗口都被 `taskkill` 结束。

> 若在任何一步未观察到预期行为，请先检查 `lanlan_server_YYYYMMDD.log` 与 API Key 配置，再参考下文故障排查。

---

## 常见问题 (FAQ)

### Q: 如何在文本和语音之间切换？
A: 可以随时切换。文本输入不会影响语音功能，两者可以无缝配合使用。

### Q: 为什么需要持久化运行器？
A: 传统的Web应用会在浏览器关闭时丢失后台服务。持久化运行器确保服务独立运行。

### Q: 如何彻底停止服务？
A: 关闭启动脚本的命令行窗口即可停止所有服务。

### Q: 可以同时使用多个浏览器实例吗？
A: 可以。后台服务支持多个浏览器连接。

### Q: 重启电脑后如何重新启动应用？
A: 再次运行 `启动网页版_持久化.bat` 即可。

### Q: 文本输入有长度限制吗？
A: 文本会自动规范化处理，包括移除特殊字符，但正常使用没有明显限制。

### Q: 消息会被保存吗？
A: 消息记录会被保存到内存存储，用于对话历史和分析。

---

## 技术信息

### 文本输入的工作原理

```
浏览器端                服务器端
─────────────────────────────────
输入文字 ──WebSocket──→ 接收消息
       ←─── JSON ──← 规范化处理
显示响应 ←─ 发送响应 ←─ API调用
```

### WebSocket 文本载荷
```json
{
  "action": "start_session",
  "input_type": "text"
}
```
```json
{
  "action": "stream_data",
  "input_type": "text",
  "data": "你好呀"
}
```
后台会将 `stream_data` 转换成 OpenAI Realtime 所需的 `input_text_buffer.append` 事件，从而让实时模型理解纯文字输入。

### 支持的文本格式

- ✅ 中文、英文、日文等多种语言
- ✅ 普通文字消息
- ✅ 符号和标点
- ✅ 链接和特殊字符（会被规范化）

### 性能考虑

- 消息立即发送（无延迟）
- 服务器自动优化处理
- 支持长对话历史
- 自动清理过期数据

---

## 故障排除

### 问题1: 启动脚本提示“错误：找不到Python环境”
**解决**：
- 确认项目根目录存在 `env\python.exe`。
- 如果缺失，请重新解压一键包或运行 `python -m venv env && env\\Scripts\\pip install -r requirements.txt`。
- 确保脚本是在项目根目录执行，避免通过快捷方式跳转到其他磁盘。

### 问题2: 状态栏一直显示“WebSocket连接未建立，请稍后重试”
**解决**：
- 等待 5 秒确认 Memory Server/Main Server 均已启动，再刷新页面。
- 检查两个服务器窗口是否有异常堆栈，如有则先解决（常见为端口被占用）。
- 确认没有其他程序占用 8000 端口，可尝试重启电脑。
- 查看 `lanlan_server_YYYYMMDD.log` 是否记载“Failed to bind”或 API Key 相关错误。

### 问题3: 文本消息发送后没有AI回复
**排查步骤**：
1. 观察页面状态是否从“连接已建立”变为“正在对话...”，否则说明 `start_session` 未执行，点击“重置会话”后重新发送首条消息。
2. 确认设置页中的 API Key 有效，必要时重新保存。
3. 打开 `lanlan_server_YYYYMMDD.log`，搜索 `input_type='text'` 或模型报错信息。
4. 检查 `Memory Server` 窗口是否出现内存/记忆写入异常，若有则重启脚本。

### 问题4: 文本输入框不可见
**解决**:
- 刷新浏览器页面
- 清除浏览器缓存
- 尝试不同的浏览器

### 问题5: 消息无法发送
**解决**:
- 确认WebSocket状态为“连接已建立”
- 查看浏览器控制台错误信息（F12）
- 点击“重置会话”后重新发送首条文本
- 重启应用并检查 `lanlan_server_YYYYMMDD.log`

### 问题6: 服务停止或浏览器无法连接
**解决**:
- 关闭并重新运行启动脚本，等待“服务已启动”提示
- 检查防火墙或杀毒软件是否拦截 8000 端口
- 使用 `http://127.0.0.1:8000` 取代 `localhost`
- 如果脚本窗口已关闭，请重新启动服务

---

## 反馈和建议

如有任何问题或建议，请参考项目文档或联系开发团队。

---

## 更新日志

### 版本 X.X.X

**新增功能:**
- ✨ 文本输入功能
- ✨ Windows持久化Web运行器
- ✨ 改进的启动脚本

**改进:**
- 📊 优化消息处理流程
- 📊 增强错误处理
- 📊 改进用户界面

**修复:**
- 🐛 WebSocket连接稳定性
- 🐛 消息规范化处理

---

**祝您使用愉快！** 🎉
