# Project Lanlan 使用指南 - 新功能

## 新功能概述

本版本为Project Lanlan添加了两个重要功能：

### 1. 文本输入功能 💬
在聊天窗口中添加了文本输入框，允许用户通过文字与AI互动，而不仅限于语音输入。

### 2. Windows持久化Web运行器 🔄
改进了Windows启动脚本，确保后台服务持续运行，即使浏览器关闭也不会影响服务。

---

## 功能使用指南

### 文本输入功能使用

#### 第一步：启动应用
运行任一启动脚本：
- `启动网页版.bat` - 标准启动脚本
- `启动网页版_持久化.bat` - 推荐使用（提供更好的持久化支持）

#### 第二步：找到文本输入框
应用启动后，在左下角的聊天窗口底部可以看到：
- 文本输入框：显示"输入你的消息..."提示文字
- 发送按钮：蓝色的"发送"按钮

#### 第三步：输入消息
有两种方式发送消息：

**方式1：使用发送按钮**
1. 点击文本输入框
2. 输入你的消息
3. 点击"发送"按钮
4. 等待AI的响应

**方式2：使用键盘快捷键**
1. 点击文本输入框
2. 输入你的消息
3. 按 **Enter** 键
4. 等待AI的响应

#### 第四步：查看响应
- AI的响应会显示在聊天窗口中
- 消息带有时间戳
- 支持与语音输入无缝集成

### 文本输入的优势

✅ **随时随地输入** - 不需要麦克风或语音权限  
✅ **准确无误** - 避免语音识别错误  
✅ **隐私保护** - 不需要录音  
✅ **快速交互** - 即时发送消息  
✅ **与语音混合** - 可在语音和文本之间切换  

---

## Windows持久化运行器

### 架构说明

所有启动脚本现在都通过统一的 **PowerShell 启动器** (`scripts/launch_web_runner.ps1`) 来管理服务进程。

#### 启动流程

```
启动批处理文件 (*.bat)
     ↓
调用 PowerShell 脚本
     ↓
启动 memory_server.py (进程1)
     ↓
启动 main_server.py (进程2)
     ↓
等待用户关闭窗口或按 Ctrl+C
     ↓
清理并关闭两个进程
```

### 推荐启动方式

使用 `启动网页版_持久化.bat` 获得最佳体验：

```
双击运行 启动网页版_持久化.bat
↓
PowerShell 窗口显示启动信息
↓
请手动打开浏览器访问 http://127.0.0.1:8000
↓
关闭浏览器标签页/窗口 - 服务继续运行
↓
关闭启动脚本窗口或按 Ctrl+C，服务停止
```

### 优势说明

| 功能 | 说明 |
|-----|-----|
| **进程管理** | PowerShell 直接管理子进程，精确控制启停 |
| **持久化** | 浏览器关闭后服务仍在运行 |
| **日志记录** | stdout/stderr 重定向到 `logs/` 目录便于调试 |
| **捕获 PID** | 捕获子进程 ID 确保准确清理 |
| **异常处理** | try/finally 确保任何情况下都能清理资源 |
| **Ctrl+C 支持** | 按 Ctrl+C 可立即停止所有服务 |

### 快速启动

**Windows用户:**
1. 在项目文件夹中找到 `启动网页版_持久化.bat`
2. 双击运行
3. 根据提示操作

**浏览器重新连接:**
1. 关闭浏览器后，打开新浏览器窗口
2. 访问 `http://127.0.0.1:8000`
3. 应用恢复运行（服务从未停止）

### 日志文件

启动脚本会自动在 `logs/` 目录下创建日志文件：
- `logs/memory_server.log` - 内存服务器的输出日志
- `logs/main_server.log` - 主服务器的输出日志

这些日志文件对于调试问题很有帮助。

---

## 完整操作流程

### 第一次使用

```
1. 双击 启动网页版_持久化.bat
2. 等待浏览器自动打开
3. 在聊天窗口中输入文字
4. 选择语言：中文/英文等
5. 点击发送或按Enter
6. 等待AI响应
```

### 日常使用流程

```
输入消息
  ↓
选择发送方式（按钮或Enter）
  ↓
等待响应
  ↓
继续聊天或使用语音
  ↓
关闭浏览器（服务继续运行）
  ↓
重新打开浏览器访问
  ↓
继续使用
```

---

## 常见问题 (FAQ)

### Q: 如何在文本和语音之间切换？
A: 可以随时切换。文本输入不会影响语音功能，两者可以无缝配合使用。

### Q: 为什么需要持久化运行器？
A: 传统的Web应用会在浏览器关闭时丢失后台服务。持久化运行器确保服务独立运行。

### Q: 如何彻底停止服务？
A: 有两种方式：
   1. 关闭启动脚本的 PowerShell 窗口
   2. 在 PowerShell 窗口中按 Ctrl+C

两种方式都会同时终止内存服务器和主服务器两个进程。

### Q: 可以同时使用多个浏览器实例吗？
A: 可以。后台服务支持多个浏览器连接。

### Q: 重启电脑后如何重新启动应用？
A: 再次运行 `启动网页版_持久化.bat` 即可。

### Q: 文本输入有长度限制吗？
A: 文本会自动规范化处理，包括移除特殊字符，但正常使用没有明显限制。

### Q: 消息会被保存吗？
A: 消息记录会被保存到内存存储，用于对话历史和分析。

---

## 技术信息

### 文本输入的工作原理

```
浏览器端                服务器端
─────────────────────────────────
输入文字 ──WebSocket──→ 接收消息
       ←─── JSON ──← 规范化处理
显示响应 ←─ 发送响应 ←─ API调用
```

### 支持的文本格式

- ✅ 中文、英文、日文等多种语言
- ✅ 普通文字消息
- ✅ 符号和标点
- ✅ 链接和特殊字符（会被规范化）

### 性能考虑

- 消息立即发送（无延迟）
- 服务器自动优化处理
- 支持长对话历史
- 自动清理过期数据

---

## 故障排除

### 问题1: 文本输入框不可见
**解决**: 
- 刷新浏览器页面
- 清除浏览器缓存
- 尝试不同的浏览器

### 问题2: 消息无法发送
**解决**:
- 检查WebSocket连接状态
- 查看浏览器控制台错误信息
- 重启应用

### 问题3: 服务停止了
**解决**:
- 关闭并重新运行启动脚本
- 检查防火墙设置
- 查看是否有其他应用占用端口
- 查看 `logs/` 目录下的日志文件了解具体错误

### 问题4: 浏览器无法连接
**解决**:
- 确认启动脚本仍在运行
- 访问 http://127.0.0.1:8000 而不是 localhost
- 检查Windows防火墙设置
- 查看 PowerShell 窗口的输出信息，确认两个服务都已启动

### 问题5: 一个服务启动失败
**解决**:
- 查看 `logs/memory_server.log` 或 `logs/main_server.log` 了解具体错误
- 确保 `env/python.exe` 存在
- 检查系统资源（内存、CPU）是否充足
- 查看是否有其他应用占用相同的端口（8000）

---

## 反馈和建议

如有任何问题或建议，请参考项目文档或联系开发团队。

---

## 更新日志

### 版本 X.X.X

**新增功能:**
- ✨ 文本输入功能
- ✨ Windows持久化Web运行器
- ✨ 改进的启动脚本

**改进:**
- 📊 优化消息处理流程
- 📊 增强错误处理
- 📊 改进用户界面

**修复:**
- 🐛 WebSocket连接稳定性
- 🐛 消息规范化处理

---

**祝您使用愉快！** 🎉
