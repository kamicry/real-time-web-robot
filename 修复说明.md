# 修复说明 - 启动和文字输入改进

## 已解决的问题

### ✅ 问题 1: 启动脚本失败
**症状**: 双击启动脚本后，直接打开Python命令行（REPL），而不是运行服务器

**根本原因**: 
- 使用 `start "" /B` 参数在后台启动进程
- `/B` 参数在某些情况下会导致Python直接打开交互式命令行

**解决方案**:
- 改用 `start "窗口标题" /MIN` 启动服务
- 每个服务在独立的最小化窗口中运行
- Memory Server 窗口标题: "Memory Server"
- Main Server 窗口标题: "Main Server"

### ✅ 问题 2: 连接被拒绝错误
**症状**: 打开网页后显示"目标计算机积极拒绝连接"

**根本原因**:
- 服务启动需要时间
- 之前的等待时间(Memory: 3秒, Main: 2秒)不足以完成初始化

**解决方案**:
- 增加启动等待时间（都改为5秒）
- 总等待时间: 10秒
- 改进WebSocket错误提示信息
- 添加自动重连机制（3秒间隔）

### ✅ 问题 3: 文字输入依赖麦克风
**症状**: 
- 无法访问麦克风时，文字输入也无法使用
- 需要先点击麦克风按钮才能使用文字输入

**根本原因**:
- 文字输入依赖 `isRecording` 状态（麦克风状态）
- 没有独立的文字会话管理机制

**解决方案**:
- 添加独立的 `textSessionActive` 标志
- 文字输入完全独立于麦克风状态
- 第一次发送文字消息时自动启动文字会话
- 麦克风失败不影响文字输入功能

## 修改的文件列表

### 批处理脚本
1. `启动网页版.bat`
2. `启动网页版_持久化.bat`

**主要修改**:
- 启动方式: `/B` → `/MIN` （带窗口标题）
- 等待时间: 增加到5秒
- 清理逻辑: 使用窗口标题精确终止进程

### 前端代码
3. `static/app.js`

**主要修改**:
- 添加 `textSessionActive` 标志（第26行）
- 重写 `sendTextMessage()` 函数（第435-485行）
  - 检查WebSocket连接状态
  - 自动启动文字会话
  - 显示Live2D角色
  - 独立于麦克风状态
- WebSocket连接处理（第39-43行）
  - 连接成功时重置文字会话状态
  - 改进状态消息
- WebSocket断开处理（第144-150行）
  - 重置文字会话状态
  - 自动重连
- WebSocket错误处理（第152-155行）
  - 详细的错误提示
- 麦克风失败处理（第230-238行）
  - 明确告知文字输入仍可用
- 会话重置处理（第424行）
  - 重置文字会话状态

## 使用指南

### 启动服务

1. **运行启动脚本**
   ```
   启动网页版_持久化.bat  （推荐）
   或
   启动网页版.bat
   ```

2. **等待服务启动**
   - 等待约10秒
   - 会看到两个最小化窗口（Memory Server 和 Main Server）
   - 看到"服务已启动！"消息

3. **打开浏览器**
   - 手动打开浏览器
   - 访问: http://127.0.0.1:8000
   - 等待看到"连接已建立，可以开始使用文字输入或语音输入"

### 使用文字输入（新功能）

**不需要点击任何按钮！**

1. 直接在页面底部输入框输入文字
2. 点击"发送"按钮或按回车键
3. 第一次发送时会自动：
   - 启动文字会话
   - 显示Live2D角色
   - 连接后端服务
4. 后续消息直接发送

**即使麦克风无法访问，文字输入仍然可用！**

### 使用语音输入（原有功能）

1. 点击麦克风按钮
2. 允许浏览器麦克风权限
3. 等待初始化（约2.5秒）
4. 开始语音对话

**如果麦克风失败**:
- 会显示: "无法访问麦克风，但您仍可使用文字输入功能"
- 文字输入不受影响

### 停止服务

- 关闭启动脚本的命令窗口
- 会自动终止所有服务进程
- 也可以手动关闭任务管理器中的 Memory Server 和 Main Server 窗口

## 技术细节

### 会话管理

**语音会话** (`isRecording`):
- 控制: 麦克风按钮
- 类型: `input_type='audio'`
- 依赖: 麦克风权限

**文字会话** (`textSessionActive`):
- 控制: 自动启动（首次文字消息）
- 类型: `input_type='text'`
- 依赖: 仅需WebSocket连接

两个会话**完全独立**，互不影响。

### 启动流程

```
启动脚本 
  ↓
启动 Memory Server (窗口: "Memory Server")
  ↓
等待 5 秒
  ↓
启动 Main Server (窗口: "Main Server")
  ↓
等待 5 秒
  ↓
服务就绪 (总共约10秒)
```

### 连接状态提示

| 状态 | 提示信息 |
|------|----------|
| 连接成功 | "连接已建立，可以开始使用文字输入或语音输入" |
| 连接断开 | "WebSocket连接已断开，3秒后尝试重新连接..." |
| 连接失败 | "连接服务器失败，请确保服务已启动。请检查 http://127.0.0.1:8000 是否可访问" |
| 麦克风失败 | "无法访问麦克风，但您仍可使用文字输入功能" |
| 文字对话中 | "正在对话..." |

### 进程清理

关闭启动脚本窗口时:
1. 执行 `taskkill /F /FI "WINDOWTITLE eq Memory Server*"`
2. 执行 `taskkill /F /FI "WINDOWTITLE eq Main Server*"`
3. 备用清理: `taskkill /F /IM python.exe /FI "WINDOWTITLE eq*Server*"`

确保所有服务进程被正确终止。

## 常见问题

### Q: 为什么启动后需要等待10秒？
A: 服务需要初始化：
- Memory Server 加载内存数据库
- Main Server 初始化AI模型连接
- WebSocket服务器启动

### Q: 文字输入需要点击麦克风按钮吗？
A: **不需要！** 直接输入并发送即可。第一次发送时会自动启动文字会话。

### Q: 麦克风失败后还能用吗？
A: 麦克风失败不影响文字输入。文字输入是完全独立的功能。

### Q: 如何确认服务已启动？
A: 
1. 任务栏会显示两个最小化窗口
2. 任务管理器中能看到两个Python进程
3. 浏览器中看到"连接已建立"消息

### Q: 如何完全关闭服务？
A: 关闭启动脚本的命令窗口，会自动清理所有进程。

## 测试建议

1. **启动测试**
   - 双击启动脚本
   - 验证看到两个最小化窗口
   - 验证没有打开Python REPL

2. **连接测试**
   - 等待10秒
   - 打开 http://127.0.0.1:8000
   - 验证看到"连接已建立"消息

3. **文字输入测试**
   - 不点击任何按钮
   - 直接在输入框输入"你好"
   - 按回车或点击发送
   - 验证Live2D角色出现
   - 验证收到回复

4. **麦克风失败测试**
   - 拒绝麦克风权限
   - 验证错误提示包含"仍可使用文字输入"
   - 验证文字输入仍然工作

5. **清理测试**
   - 关闭启动脚本窗口
   - 验证任务管理器中Python进程消失

## 版本信息

- 分支: `fix-startup-open-python-repl-connection-refused-enable-always-text-input`
- 修改日期: 2024
- 主要改进:
  - 启动脚本可靠性
  - 连接稳定性
  - 文字输入独立性
