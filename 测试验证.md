# 修复验证测试

## 快速测试步骤

### 测试 1: 启动脚本修复验证
**目标**: 验证启动脚本不再打开Python REPL

1. 双击 `启动网页版_持久化.bat`
2. ✅ 应该看到：
   - 命令窗口显示"正在启动服务器..."
   - 任务栏出现两个最小化窗口："Memory Server" 和 "Main Server"
   - **不应该**出现Python交互式命令行(>>>)
3. 等待10秒
4. 看到"服务已启动！"消息

### 测试 2: 连接问题修复验证
**目标**: 验证网页不再报"连接被拒绝"错误

1. 启动服务后等待10秒
2. 打开浏览器访问 http://127.0.0.1:8000
3. ✅ 应该看到：
   - 页面正常加载
   - 状态显示："连接已建立，可以开始使用文字输入或语音输入"
   - **不应该**看到"目标计算机积极拒绝连接"错误

### 测试 3: 文字输入独立性验证
**目标**: 验证文字输入不依赖麦克风

#### 3.1 直接使用文字输入
1. 打开网页后，**不要点击麦克风按钮**
2. 直接在页面底部输入框输入"你好"
3. 按回车或点击发送按钮
4. ✅ 应该看到：
   - Live2D角色自动出现
   - 收到AI回复
   - 状态显示"正在对话..."

#### 3.2 麦克风失败后使用文字输入
1. 点击麦克风按钮
2. 在浏览器权限弹窗中选择"拒绝"或"阻止"
3. ✅ 应该看到：
   - 状态显示："无法访问麦克风，但您仍可使用文字输入功能"
   - 麦克风按钮恢复可点击状态
4. 在输入框输入"测试文字输入"并发送
5. ✅ 应该看到：
   - 文字输入正常工作
   - 收到AI回复

### 测试 4: WebSocket重连验证
**目标**: 验证连接断开后自动重连

1. 在服务运行时，在任务管理器中强制结束"Main Server"进程
2. ✅ 应该看到：
   - 状态显示："WebSocket连接已断开，3秒后尝试重新连接..."
3. 重新运行 `启动网页版_持久化.bat`
4. 等待10秒
5. ✅ 应该看到：
   - 页面自动重连
   - 状态恢复为"连接已建立..."

### 测试 5: 服务清理验证
**目标**: 验证关闭启动脚本能正确终止所有进程

1. 关闭启动脚本的命令窗口（或按任意键后关闭）
2. 打开任务管理器查看进程
3. ✅ 应该看到：
   - "Memory Server"窗口消失
   - "Main Server"窗口消失
   - 没有残留的python.exe进程

### 测试 6: 文本输入端到端流程
**目标**: 验证从启动到关闭的完整文字会话体验

1. 双击 `启动网页版_持久化.bat`，等待"服务已启动！"提示。
2. 手动打开浏览器访问 http://127.0.0.1:8000。
3. 在文本框输入"你好"并发送，观察Live2D出现，状态显示"正在对话..."。
4. 确认收到AI文本/语音回复。
5. 打开 `lanlan_server_YYYYMMDD.log`，确认包含 `start_session input_type='text'` 和 `stream_data` 记录。
6. 关闭浏览器标签页，再次访问 http://127.0.0.1:8000。
7. ✅ 应该看到：
   - 页面仍能继续对话
   - 日志中新增一条 `/api/beacon/page_closed` 记录
8. 按 Ctrl+C 或关闭启动脚本窗口，确认两个服务器窗口被自动结束。

## 预期行为总结

| 场景 | 旧版本行为 | 新版本行为 |
|------|-----------|-----------|
| 启动脚本 | 打开Python REPL | 正确启动服务 |
| 打开网页 | 连接被拒绝 | 正常连接 |
| 文字输入 | 需要先启动麦克风 | 直接可用 |
| 麦克风失败 | 无法使用任何功能 | 文字输入仍可用 |
| 连接断开 | 需要刷新页面 | 自动重连 |

## 常见问题排查

### Q: 启动脚本窗口闪退或提示“错误：找不到Python环境”
A:
- 确认项目根目录存在 `env\python.exe`
- 如不存在，重新解压一键包或运行 `python -m venv env && env\\Scripts\\pip install -r requirements.txt`
- 右键以管理员身份运行脚本，避免权限被拦截

### Q: 状态栏一直显示“WebSocket连接未建立”或浏览器提示“连接被拒绝”
A:
1. 等待 5-10 秒确保 Memory Server/Main Server 均已启动
2. 检查两个最小化窗口是否报错
3. 确认没有其他程序占用 8000 端口（必要时重启电脑）
4. 查看 `lanlan_server_YYYYMMDD.log`，搜索 `Failed to bind` 或 API Key 相关报错

### Q: 文字输入没有反应 / 没有收到AI回复
A:
1. 发送首条消息前，确认页面状态已从“连接已建立”变为“正在对话”
2. 点击“重置会话”重新发送首条消息，确保触发 `start_session`
3. 打开 `lanlan_server_YYYYMMDD.log`，确认是否存在 `input_type='text'` 记录或模型异常
4. 查看浏览器控制台（F12）是否提示 API Key 未配置等错误

### Q: 服务无法停止
A:
1. 在脚本窗口按 Ctrl+C 或直接关闭窗口
2. 若仍有残留 python.exe，打开任务管理器手动结束“Memory Server”“Main Server”相关进程

## 成功标准

所有测试通过的标志：
- ✅ 启动脚本不打开Python REPL
- ✅ 网页能正常连接，无"连接被拒绝"错误
- ✅ 文字输入不需要麦克风权限
- ✅ 麦克风失败后文字输入仍可用
- ✅ WebSocket断开后自动重连
- ✅ 文本输入端到端流程可记录 `input_type='text'`/`page_closed` 日志并在重开浏览器后继续
- ✅ 关闭启动脚本能清理所有进程

如果所有测试通过，说明修复成功！
