# 修复验证测试

## 快速测试步骤

### 测试 1: 启动脚本修复验证
**目标**: 验证启动脚本不再打开Python REPL

1. 双击 `启动网页版_持久化.bat`
2. ✅ 应该看到：
   - 命令窗口显示"正在启动服务器..."
   - 任务栏出现两个最小化窗口："Memory Server" 和 "Main Server"
   - **不应该**出现Python交互式命令行(>>>)
3. 等待10秒
4. 看到"服务已启动！"消息

### 测试 2: 连接问题修复验证
**目标**: 验证网页不再报"连接被拒绝"错误

1. 启动服务后等待10秒
2. 打开浏览器访问 http://127.0.0.1:8000
3. ✅ 应该看到：
   - 页面正常加载
   - 状态显示："连接已建立，可以开始使用文字输入或语音输入"
   - **不应该**看到"目标计算机积极拒绝连接"错误

### 测试 3: 文字输入独立性验证
**目标**: 验证文字输入不依赖麦克风

#### 3.1 直接使用文字输入
1. 打开网页后，**不要点击麦克风按钮**
2. 直接在页面底部输入框输入"你好"
3. 按回车或点击发送按钮
4. ✅ 应该看到：
   - Live2D角色自动出现
   - 收到AI回复
   - 状态显示"正在对话..."

#### 3.2 麦克风失败后使用文字输入
1. 点击麦克风按钮
2. 在浏览器权限弹窗中选择"拒绝"或"阻止"
3. ✅ 应该看到：
   - 状态显示："无法访问麦克风，但您仍可使用文字输入功能"
   - 麦克风按钮恢复可点击状态
4. 在输入框输入"测试文字输入"并发送
5. ✅ 应该看到：
   - 文字输入正常工作
   - 收到AI回复

### 测试 4: WebSocket重连验证
**目标**: 验证连接断开后自动重连

1. 在服务运行时，在任务管理器中强制结束"Main Server"进程
2. ✅ 应该看到：
   - 状态显示："WebSocket连接已断开，3秒后尝试重新连接..."
3. 重新运行 `启动网页版_持久化.bat`
4. 等待10秒
5. ✅ 应该看到：
   - 页面自动重连
   - 状态恢复为"连接已建立..."

### 测试 5: 服务清理验证
**目标**: 验证关闭启动脚本能正确终止所有进程

1. 关闭启动脚本的命令窗口（或按任意键后关闭）
2. 打开任务管理器查看进程
3. ✅ 应该看到：
   - "Memory Server"窗口消失
   - "Main Server"窗口消失
   - 没有残留的python.exe进程

## 预期行为总结

| 场景 | 旧版本行为 | 新版本行为 |
|------|-----------|-----------|
| 启动脚本 | 打开Python REPL | 正确启动服务 |
| 打开网页 | 连接被拒绝 | 正常连接 |
| 文字输入 | 需要先启动麦克风 | 直接可用 |
| 麦克风失败 | 无法使用任何功能 | 文字输入仍可用 |
| 连接断开 | 需要刷新页面 | 自动重连 |

## 常见问题排查

### Q: 还是看到"连接被拒绝"
A: 可能原因：
- 等待时间不够，再等待5-10秒
- 服务启动失败，检查Memory Server和Main Server窗口是否有错误
- 端口被占用，重启电脑后重试

### Q: 文字输入没有反应
A: 检查：
1. WebSocket连接状态（页面顶部状态）
2. 浏览器控制台是否有错误（F12）
3. 尝试刷新页面重新连接

### Q: 启动脚本窗口闪退
A: 可能原因：
- Python环境不存在，检查env目录
- 脚本权限问题，右键"以管理员身份运行"

### Q: 服务无法停止
A: 手动清理：
1. 打开任务管理器
2. 找到所有python.exe进程
3. 右键"结束任务"

## 成功标准

所有测试通过的标志：
- ✅ 启动脚本不打开Python REPL
- ✅ 网页能正常连接，无"连接被拒绝"错误
- ✅ 文字输入不需要麦克风权限
- ✅ 麦克风失败后文字输入仍可用
- ✅ WebSocket断开后自动重连
- ✅ 关闭启动脚本能清理所有进程

如果所有测试通过，说明修复成功！
