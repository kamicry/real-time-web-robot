# 修改说明

## 修复的问题

### 1. 启动脚本失败问题
**问题**: 启动脚本直接打开Python命令行页面，而不是运行服务
**原因**: 使用 `start "" /B` 参数在后台启动进程，导致Python直接打开而不是执行脚本
**解决方案**:
- 改用 `start "窗口标题" /MIN` 参数，在最小化的新窗口中启动服务
- Memory Server窗口标题: "Memory Server"
- Main Server窗口标题: "Main Server"
- 服务现在会在独立的最小化窗口中运行，可以在任务栏中看到

### 2. 连接被拒绝问题
**问题**: 网页打开后报错"目标计算机积极拒绝连接"
**原因**: 服务启动需要时间，但等待时间不够
**解决方案**:
- Memory Server启动等待时间: 3秒 → 5秒
- Main Server启动等待时间: 2秒 → 5秒
- 改进WebSocket错误提示，明确告知用户服务未启动
- 错误消息现在会显示: "连接服务器失败，请确保服务已启动。请检查 http://127.0.0.1:8000 是否可访问"

### 3. 文字输入依赖麦克风问题
**问题**: 无法访问麦克风时，文字输入也无法使用；需要等待语音输入开始连接后才能使用文字输入
**解决方案**:
- 添加 `textSessionActive` 标志，独立追踪文字会话状态
- 文字输入不再依赖 `isRecording` 状态（麦克风状态）
- 第一次发送文字消息时自动启动文字会话（input_type='text'）
- 麦克风失败时明确提示: "无法访问麦克风，但您仍可使用文字输入功能"

## 修改的文件

1. **启动网页版.bat**
   - 改用最小化窗口启动方式
   - 增加启动等待时间
   - 添加清理逻辑

2. **启动网页版_持久化.bat**
   - 改用最小化窗口启动方式
   - 增加启动等待时间
   - 改进进程终止逻辑

3. **static/app.js**
   - 添加 `textSessionActive` 标志
   - 重写 `sendTextMessage()` 函数，使其完全独立于麦克风状态
   - 改进WebSocket连接错误处理
   - 麦克风失败时不影响文字输入功能
   - 改进用户提示信息

## 使用说明

### 启动服务
1. 运行 `启动网页版_持久化.bat` 或 `启动网页版.bat`
2. 等待10秒左右，确保服务完全启动
3. 手动打开浏览器访问 http://127.0.0.1:8000
4. 看到"连接已建立，可以开始使用文字输入或语音输入"消息后即可使用

### 使用文字输入
1. **不需要点击麦克风按钮**
2. 直接在页面底部的输入框中输入文字
3. 点击发送按钮或按回车键发送
4. 第一次发送会自动启动文字会话，显示Live2D角色
5. 即使麦克风无法访问，文字输入仍然可用

### 使用语音输入
1. 点击麦克风按钮
2. 允许浏览器访问麦克风权限
3. 开始语音对话
4. 如果麦克风权限被拒绝，会显示提示，但文字输入仍然可用

### 停止服务
- **持久化模式**: 关闭启动脚本窗口即可停止所有服务
- **非持久化模式**: 按任意键后关闭窗口即可停止所有服务

## 技术细节

### 文字会话 vs 语音会话
- **语音会话**: 由 `isRecording` 标志控制，通过麦克风按钮启动（input_type='audio'）
- **文字会话**: 由 `textSessionActive` 标志控制，第一次发送消息时自动启动（input_type='text'）
- 两个会话独立运行，互不影响
- 文字会话无需等待，随时可用

### WebSocket连接状态
- 连接建立: "连接已建立，可以开始使用文字输入或语音输入"
- 连接断开: "WebSocket连接已断开，3秒后尝试重新连接..."
- 连接失败: "连接服务器失败，请确保服务已启动。请检查 http://127.0.0.1:8000 是否可访问"
- 自动重连机制: 3秒后自动尝试重新连接

### 进程管理
- Memory Server 和 Main Server 运行在独立的最小化窗口中
- 可以在任务管理器中看到两个Python进程（标题为"Memory Server"和"Main Server"）
- 关闭启动脚本窗口时会自动终止这两个服务进程
